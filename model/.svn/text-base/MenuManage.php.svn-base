<?php
/**
 * @author rose <qiuyang03@baidu.com>
 */
class MenuManage {
	private $table = 'data_menu';
	private $menudao;
	function __construct(){
		$this->menudao =  new BaseDao($this->table);
	}
	function insert(){
		$name = Util::req('name');
		$url = Util::req('url');
		$image = Util::req('image', 'sql');
		$sequence = Util::req('sequence', 'sql');
		$parent_id = Util::req('parent_id', 'sql');
		$this->menudao->setFilteValue('name', $name);
		$this->menudao->setFilteValue('url', $url);
		$this->menudao->setFilteValue('image', $image);
		$this->menudao->setFilteValue('sequence', $sequence);
		$this->menudao->setFilteValue('parent_id', $parent_id);
		//if menu exists,return the message. modified by zhulukun in 2016/4/25
		if($this->is_menu_exist($name,$parent_id)){
			return "menu_exist";
		}
		$this->menudao->insert();
	}
	
	
	function get(){
		$id = Util::req("id", "sql");
		$this->menudao->setId($id);
		$rst = $this->menudao->get();
		return $rst;
	}
	
	function update(){
		$id = Util::req('id');
		$name = Util::req('name');
		$url = Util::req('url');
		$image = Util::req('image', 'sql');
		$sequence = Util::req('sequence', 'sql');
		$parent_id = Util::req('parent_id', 'sql');
		$this->menudao->setFilteValue('name', $name);
		$this->menudao->setFilteValue('url', $url);
		$this->menudao->setFilteValue('image', $image);
		$this->menudao->setFilteValue('sequence', $sequence);
		$this->menudao->setFilteValue('parent_id', $parent_id);
		$this->menudao->setConditionFV('id', $id);
		$this->menudao->update();
	}
	
	function delete(){
		$id = Util::req('id');
		if (in_array($id, array(1,2,3,4))){
			echo '<script>alert("系统菜单不能删除")</script>';
			return;
		}
		$this->menudao->cleanConditionFV();
		$this->menudao->setConditionFV('id', $id);
		$this->menudao->delete();
	}
	
	/**
	 * 分页获取列表 拥有高级查询+分页为一体
	 * @return
	 */
	function getList($condition = true){
		$page_size = Util::req('page_size');
		$page_num = Util::req('page_num');
		$name = Util::req('name');
		
		$this->menudao->setColumns('id');
		$this->menudao->setColumns('name');
		$this->menudao->setColumns('url');
		$this->menudao->setColumns('image');
		$this->menudao->setColumns('parent_id');
		$this->menudao->setColumns('is_leaf');
		$this->menudao->setColumns('sequence');
		$this->menudao->setOrderBy('id', 'asc');
	//	$page = new Page($page_size, $page_num);
		//封装查询条件
		if ($condition) {
			if ($name) {
				$this->menudao->setConditionFV('name', $name, 'like');
				$page->setSearchKV('name', $name);
			} 
		}
		
	//	$this->menudao->setPage($page);
		$results = $this->get_all_menu();
	//	print_r($results);
	//	die();
		return $results;
	}
	/**
	 * 获取所有主菜单
	 * @return
	 */
	function getParentList(){
		$this->menudao->setColumns('id');
		$this->menudao->setColumns('name');
		$this->menudao->setColumns('url');
		$this->menudao->setColumns('image');
		$this->menudao->setColumns('parent_id');
		$this->menudao->setColumns('is_leaf');
		$this->menudao->setOrderBy('id', 'asc');
		$this->menudao->setConditionFV('parent_id', -1);
		$results =  $this->menudao->getListNoPage();
		return $results;
	}
	
	/**
	 * 获取所有菜单
	 * 数据结构
	 * array(
	 * "root_array"=>array()
	 * "sub_array"=>array(array(),array(),array()...)
	 * )
	 */
	function getShowMenu(){
		 //首先获取所有主菜单
		 $supperuser = $this->getSupperUser();
		 //决定是否拥有特殊菜单的显示权限
		 if (in_array(OPS_SESSION_USER, $supperuser)) {
			 $sql = "select id, name, image, url from data_menu where parent_id = -1";
		 } else {
			 $sql = "select id, name, image, url from data_menu where parent_id = -1 and is_special = 0";
		 }		
		 $result = $this->menudao->query($sql);
		 $root_array = array();		 
		 while ($obj = mysql_fetch_assoc($result)) {
		 	//获取其子菜单  (目前定义二级菜单逻辑)
		 	$sub_array = array();
		 	$root_id =  $obj['id'];
		 	$get_sub_sql = sprintf("select * from data_menu where parent_id = %s", $root_id);
		 	$sub_result = $this->menudao->query($get_sub_sql);
		 	while ($sub_obj = mysql_fetch_assoc($sub_result)){
		 		$sub_array[] = $sub_obj;
		 	}
		 	$root_array[] = array("root_menu"=>$obj, "sub_menu"=>$sub_array);
		 }
		 return $root_array;
		 		 
	}
	private function getSupperUser() {
		$userManage = new UserManage();
		$supperUser = $userManage->getSuperUser();
		return $supperUser;
	}
	/**
	 * modified by zhulukun in 2016/4/25
	 * judge the menu if exist or not
	 * @return
	 * 
	 */
        private function is_menu_exist($name,$parent_id){
		$sql = "SELECT count(1) AS rowsnum FROM data_menu WHERE name='{$name}' AND parent_id='{$parent_id}'";
		$result=$this->menudao->query($sql);
		while ($row = mysql_fetch_assoc($result)) {
			if($row['rowsnum']>0)
			{
				return true;
			}
		}
		return false;	
	}

	/**
	 * created by zhulukun in 2016/4/26
	 * get all menu in tree mode
	 * @return
	 *
	 */
	private function get_all_menu(){
		$sql = "SELECT * FROM data_menu where parent_id = -1";
		$result = $this->menudao->query($sql);
		$root_array = array();
		while($obj = mysql_fetch_assoc($result)){
                    //get submenu
		    $sub_array=array();
		    $root_id = $obj['id'];
		    $sub_sql = "SELECT * FROM data_menu WHERE parent_id='{$root_id}'";
		    $sub_result = $this->menudao->query($sub_sql);

		    while ($sub_obj = mysql_fetch_assoc($sub_result)){
			$sub_array[] = $sub_obj;
		    }
		    $root_array[] = array("root_menu"=>$obj, "sub_menu"=>$sub_array);

		}
		return $root_array;
	}

}
